---
import Layout from '~/layouts/Layout.astro';
import { Image } from 'astro:assets';
import { getPieBySlug, getAllPies } from '~/data/pies';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const pies = getAllPies();
  return pies.map((pie) => ({
    params: { slug: pie.slug },
    props: { pie }
  }));
};

const { pie } = Astro.props;

if (!pie) {
  return Astro.redirect('/404');
}

export const metadata = {
  title: `${pie.name} | ${pie.price} | SatisPie`,
  description: pie.description,
  keywords: `${pie.name.toLowerCase()}, pie, dessert, ${pie.features.join(', ').toLowerCase()}`,
  openGraph: {
    title: pie.name,
    description: pie.shortDescription,
    image: pie.image,
    url: `/pies/${pie.slug}`
  }
};

// Generate structured data for the product
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": pie.name,
  "description": pie.description,
  "image": pie.image,
  "offers": {
    "@type": "Offer",
    "price": pie.price.replace('$', ''),
    "priceCurrency": "USD",
    "availability": pie.available ? "https://schema.org/InStock" : "https://schema.org/OutOfStock"
  },
  "brand": {
    "@type": "Brand",
    "name": "SatisPie"
  },
  "category": "Dessert",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "reviewCount": "127"
  }
};
---

<Layout metadata={metadata}>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <main class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        <li><a href="/" class="hover:text-blue-600">Home</a></li>
        <li>/</li>
        <li><a href="/pies" class="hover:text-blue-600">Pies</a></li>
        <li>/</li>
        <li class="text-gray-900">{pie.name}</li>
      </ol>
    </nav>

    <!-- Product Hero Section -->
    <section class="grid lg:grid-cols-2 gap-12 mb-16">
      <!-- Image Gallery -->
      <div class="space-y-4">
        <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
          <img 
            src={pie.image} 
            alt={pie.name}
            class="w-full h-full object-cover"
          >
        </div>
        <div class="grid grid-cols-3 gap-4">
          {pie.gallery.map((image, index) => (
            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
              <img 
                src={image} 
                alt={`${pie.name} - Image ${index + 1}`}
                class="w-full h-full object-cover cursor-pointer hover:opacity-75 transition-opacity"
              >
            </div>
          ))}
        </div>
      </div>

      <!-- Product Info -->
      <div class="space-y-6">
        <div>
          <h1 class="text-4xl font-bold text-gray-900 mb-2">{pie.name}</h1>
          <p class="text-xl text-gray-600 mb-4">{pie.shortDescription}</p>
          <div class="text-3xl font-bold text-blue-600 mb-6">{pie.price}</div>
        </div>

        <!-- Features -->
        <div class="flex flex-wrap gap-2">
          {pie.features.map((feature) => (
            <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
              {feature}
            </span>
          ))}
          {pie.seasonal && (
            <span class="px-3 py-1 bg-orange-100 text-orange-800 text-sm rounded-full">
              Seasonal
            </span>
          )}
        </div>

        <!-- Allergens -->
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Allergens:</h3>
          <div class="flex flex-wrap gap-2">
            {pie.allergens.map((allergen) => (
              <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">
                {allergen}
              </span>
            ))}
          </div>
        </div>

        <!-- CTA Buttons -->
        <div class="space-y-4">
          <a 
            href="/find-pies"
            class="block w-full px-6 py-3 bg-blue-600 text-white text-center rounded-lg hover:bg-blue-700 transition-colors font-semibold"
          >
            Find in Stores
          </a>
          <a 
            href="/order-inquiry"
            class="block w-full px-6 py-3 border border-blue-600 text-blue-600 text-center rounded-lg hover:bg-blue-50 transition-colors font-semibold"
          >
            Order Inquiry
          </a>
        </div>

        <!-- Availability Status -->
        <div class="flex items-center space-x-2">
          <div class={`w-3 h-3 rounded-full ${pie.available ? 'bg-green-500' : 'bg-red-500'}`}></div>
          <span class="text-sm text-gray-600">
            {pie.available ? 'Available' : 'Currently Unavailable'}
          </span>
        </div>
      </div>
    </section>

    <!-- Product Details Tabs -->
    <section class="mb-16">
      <div class="border-b border-gray-200">
        <nav class="flex space-x-8">
          <button class="py-4 px-1 border-b-2 border-blue-500 font-medium text-blue-600">
            Description
          </button>
          <button class="py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700">
            Ingredients
          </button>
          <button class="py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700">
            Nutrition
          </button>
          <button class="py-4 px-1 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700">
            FAQ
          </button>
        </nav>
      </div>

      <!-- Tab Content -->
      <div class="py-8">
        <!-- Description Tab -->
        <div class="prose max-w-none">
          <p class="text-lg text-gray-700 leading-relaxed">{pie.description}</p>
        </div>
      </div>
    </section>

    <!-- Ingredients Section -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Ingredients</h2>
      <div class="bg-gray-50 rounded-lg p-6">
        <ul class="grid md:grid-cols-2 gap-2">
          {pie.ingredients.map((ingredient) => (
            <li class="flex items-center space-x-2">
              <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
              <span class="text-gray-700">{ingredient}</span>
            </li>
          ))}
        </ul>
      </div>
    </section>

    <!-- Nutrition Facts -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Nutrition Facts</h2>
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="text-center border-b border-gray-200 pb-4 mb-4">
          <h3 class="text-lg font-bold">Nutrition Facts</h3>
          <p class="text-sm text-gray-600">{pie.nutrition.servingSize}</p>
        </div>
        
        <div class="space-y-2">
          <div class="flex justify-between border-b border-gray-100 pb-2">
            <span class="font-medium">Calories</span>
            <span>{pie.nutrition.calories}</span>
          </div>
          <div class="flex justify-between border-b border-gray-100 pb-2">
            <span>Total Fat</span>
            <span>{pie.nutrition.totalFat}g</span>
          </div>
          <div class="flex justify-between border-b border-gray-100 pb-2 pl-4">
            <span class="text-sm">Saturated Fat</span>
            <span>{pie.nutrition.saturatedFat}g</span>
          </div>
          <div class="flex justify-between border-b border-gray-100 pb-2">
            <span>Cholesterol</span>
            <span>{pie.nutrition.cholesterol}mg</span>
          </div>
          <div class="flex justify-between border-b border-gray-100 pb-2">
            <span>Sodium</span>
            <span>{pie.nutrition.sodium}mg</span>
          </div>
          <div class="flex justify-between border-b border-gray-100 pb-2">
            <span>Total Carbohydrates</span>
            <span>{pie.nutrition.totalCarbohydrates}g</span>
          </div>
          <div class="flex justify-between border-b border-gray-100 pb-2 pl-4">
            <span class="text-sm">Dietary Fiber</span>
            <span>{pie.nutrition.dietaryFiber}g</span>
          </div>
          <div class="flex justify-between border-b border-gray-100 pb-2 pl-4">
            <span class="text-sm">Sugars</span>
            <span>{pie.nutrition.sugars}g</span>
          </div>
          <div class="flex justify-between">
            <span>Protein</span>
            <span>{pie.nutrition.protein}g</span>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Frequently Asked Questions</h2>
      <div class="space-y-4">
        {pie.faq.map((item) => (
          <div class="bg-white border border-gray-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">{item.question}</h3>
            <p class="text-gray-700">{item.answer}</p>
          </div>
        ))}
      </div>
    </section>

    <!-- Related Products -->
    <section class="mb-16">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Other Pies You Might Like</h2>
      <div class="grid md:grid-cols-4 gap-6">
        {getAllPies().filter(p => p.id !== pie.id).slice(0, 4).map((relatedPie) => (
          <a href={`/pies/${relatedPie.slug}`} class="group">
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
              <div class="aspect-square bg-gray-100">
                <img 
                  src={relatedPie.image} 
                  alt={relatedPie.name}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform"
                >
              </div>
              <div class="p-4">
                <h3 class="font-semibold text-gray-900 group-hover:text-blue-600 transition-colors">
                  {relatedPie.name}
                </h3>
                <p class="text-sm text-gray-600 mt-1">{relatedPie.shortDescription}</p>
                <p class="text-blue-600 font-semibold mt-2">{relatedPie.price}</p>
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- CTA Section -->
    <section class="text-center bg-blue-50 rounded-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Ready to Try {pie.name}?</h2>
      <p class="text-gray-600 mb-6 max-w-2xl mx-auto">
        Find our pies at local retailers or contact us for bulk orders and special events.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a 
          href="/find-pies"
          class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
        >
          Find Stores Near You
        </a>
        <a 
          href="/order-inquiry"
          class="px-6 py-3 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors font-semibold"
        >
          Order Inquiry
        </a>
      </div>
    </section>
  </main>

  <script>
    // Tab functionality
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('nav button');
      const tabContents = document.querySelectorAll('.py-8 > div');
      
      tabs.forEach((tab, index) => {
        tab.addEventListener('click', () => {
          // Remove active classes
          tabs.forEach(t => {
            t.classList.remove('border-blue-500', 'text-blue-600');
            t.classList.add('border-transparent', 'text-gray-500');
          });
          tabContents.forEach(content => content.style.display = 'none');
          
          // Add active classes
          tab.classList.remove('border-transparent', 'text-gray-500');
          tab.classList.add('border-blue-500', 'text-blue-600');
          if (tabContents[index]) {
            tabContents[index].style.display = 'block';
          }
        });
      });
    });
  </script>
</Layout> 